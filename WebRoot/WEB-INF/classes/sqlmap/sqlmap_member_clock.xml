<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="memberClock">
 
 
 
   <update id="updateMemberClock" parameterType="com.zline.zlogistics.biz.dal.entity.MemberClock" >
   
       update zlogistics.member_clock
       set end_time=now()
       where member_clock_id=#{memberClockId}
   
   </update>
   
    <insert id="addMemberAddClock" parameterType="com.zline.zlogistics.biz.dal.entity.MemberClock">
  
      insert zlogistics.member_clock
      (
      member_id,
      member_schedule_id,
      station_id,
      start_time,
      end_time,
      clock_type,
      clock_app_type,
      create_time,
      create_id,
      last_update_time,
      last_update_id,
      is_deleted,
      data_version
      )
      values
      (
      #{memberId},
      null,
      #{stationId},
      now(),
      null,
      2,
      1,
      now(),
      0,
      now(),
      0,
      0,
      0
      )
  </insert>
   
  <insert id="addMemberClock" parameterType="com.zline.zlogistics.biz.dal.entity.MemberClock">
  
      insert zlogistics.member_clock
      (
      member_id,
      member_schedule_id,
      station_id,
      start_time,
      end_time,
      clock_type,
      clock_app_type,
      create_time,
      create_id,
      last_update_time,
      last_update_id,
      is_deleted,
      data_version
      )
      values
      (
      #{memberId},
      #{memberScheduleId},
      #{stationId},
      now(),
      null,
      1,
      1,
      now(),
      0,
      now(),
      0,
      0,
      0
      )
  </insert>

  <select id="createOneAddClock" resultType="com.zline.zlogistics.biz.dal.entity.MemberClock" parameterType="com.zline.zlogistics.biz.dal.entity.MemberClock">
  SELECT
  t2.distribution_member_id    AS memberId,
  t2.work_number               AS memberWorkNum,
  t2.distribution_member_name  AS memberName,
  t4.city_name                 AS cityName,
  t3.distribution_station_name AS stationName,
  1                            AS clockStatus
FROM zlogistics.distribution_member t2
  INNER JOIN zlogistics.distribution_station t3
    ON t2.distribution_station_id = t3.distribution_station_id
      AND t3.is_deleted = 0
  INNER JOIN zlogistics.city t4
    ON t3.city_id = t4.city_id
WHERE t2.is_deleted = 0
    AND t2.distribution_member_id = #{memberId}
  </select>


   <select id="listAddClock" resultType="com.zline.zlogistics.biz.dal.entity.MemberClock" parameterType="com.zline.zlogistics.biz.dal.entity.MemberClock">
   
     SELECT
      t2.distribution_member_id    AS memberId,
  t1.member_clock_id           AS memberClockId,
  t2.work_number               AS memberWorkNum,
  t2.distribution_member_name  AS memberName,
  t4.city_name                 AS cityName,
  t3.distribution_station_name AS stationName,
  2                            AS clockStatus
FROM zlogistics.member_clock t1
  INNER JOIN zlogistics.distribution_member t2
    ON t1.member_id = t2.distribution_member_id
      AND t2.is_deleted = 0
  INNER JOIN zlogistics.distribution_station t3
    ON t1.station_id = t3.distribution_station_id
      AND t3.is_deleted = 0
  INNER JOIN zlogistics.city t4
    ON t3.city_id = t4.city_id
WHERE t1.is_deleted = 0
    AND t1.start_time IS NOT NULL
    AND t1.end_time IS NULL
    AND t1.clock_type = 2
    AND t1.member_id=#{memberId}
    AND t1.station_id=#{stationId}
   </select>


	<select id="listClock" resultType="com.zline.zlogistics.biz.dal.entity.MemberClock" parameterType="com.zline.zlogistics.biz.dal.entity.MemberClock">
	SELECT
	 t2.distribution_member_id    AS memberId,
	t5.member_clock_id as memberClockId,
  t1.member_schedule_id AS memberScheduleId,
  t2.work_number AS memberWorkNum, 
  t2.distribution_member_name AS memberName,
  t4.city_name AS cityName, 
  t3.distribution_station_name AS stationName,
  t1.schedule_name AS scheduleName,
  CASE 
    WHEN t5.start_time IS NULL AND t2.clock_status=2
       THEN 1
    WHEN t5.start_time IS NOT NULL AND t5.end_time IS  NULL AND t2.clock_status =1
         THEN 2
    ELSE 3
         END AS clockStatus
FROM zlogistics.member_schedule t1
  INNER JOIN zlogistics.distribution_member t2
    ON t1.distribution_member_id = t2.distribution_member_id
        AND   t2.is_deleted=0
  INNER JOIN zlogistics.distribution_station t3
    ON t1.distribution_station_id = t3.distribution_station_id
         AND   t3.is_deleted=0
  INNER JOIN zlogistics.city t4
    ON t4.city_id = t3.city_id
      AND   t4.is_deleted=0
  LEFT JOIN zlogistics.member_clock t5
    ON t1.member_schedule_id = t5.member_schedule_id
      AND   t5.is_deleted=0
WHERE t1.is_deleted=0 
     AND t1.schedule_date = CURRENT_DATE
     AND t2.distribution_member_id=#{memberId}
     AND t3.distribution_station_id=#{stationId} 
	</select>
</mapper>