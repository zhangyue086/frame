<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="logisticsOrderMapper">
	<resultMap type="com.zline.zlogistics.biz.dal.entity.LogisticsOrder" id="logisticsOrderFullResult" >
	
		<id     property="logisticsOrderId"				column="logistics_order_id"/>
		                  						
		<result property="logisticsOrderCode" 			column="logistics_order_code" />             					
		<result property="oldOrderCode" 				column="old_order_code" />             								
		<result property="sendStatus" 					column="send_status" />            									
		<result property="sendMethod" 					column="send_method" /> 												
		<result property="logisticsOrderStatus"			column="logistics_order_status" />   						
		<result property="needPay" 						column="need_pay" />   													
		<result property="needPayReceive" 				column="need_pay_receive" />  									
		<result property="orderEstimatedPickingTime" 	column="order_estimated_picking_time" />  				
		<result property="orderEstimatedArrivedTime" 	column="order_estimated_arrived_time" />  				
		<result property="orderPaymentMethod" 			column="order_payment_method" />   							
		<result property="orderPaymentStatus" 			column="order_payment_status" />  							
		<result property="orderPaymentMethodActual" 	column="order_payment_method_actual" />  				
		<result property="orderPaymentStatusActual" 	column="order_payment_status_actual" />  				
		<result property="actualPay" 					column="actual_pay" />                                                
		<result property="orderPrice" 					column="order_price" />                                              
		<result property="receiverId" 					column="receiver_id" />                                              
		<result property="receiverCityCode" 			column="receiver_city_code" />                                 
		<result property="logisticsInfo" 				column="logistics_info" />                                        
		<result property="inPrice" 						column="in_price" />                                                    
		<result property="goodsCount" 					column="goods_count" />                                              
		<result property="goodsWeight" 					column="goods_weight" />                                            
		<result property="receiverProvince" 			column="receiver_province" />                                  
		<result property="receiverCity" 				column="receiver_city" />                                          
		<result property="receiverCounty" 				column="receiver_county" />                                     
		<result property="receiverStreet" 				column="receiver_street" />                                      
		<result property="receiverAddress" 				column="receiver_address" />                                    
		<result property="receiverMobile" 				column="receiver_mobile" />                                      
		<result property="receiverPhone" 				column="receiver_phone" />                                        
		<result property="goodsReceiver" 				column="goods_receiver" />                                        
		<result property="userRemark"					column="user_remark" />                                              
		<result property="shopId" 						column="shop_id" />                                                      
		<result property="shopName" 					column="shop_name" />                                                  
		<result property="shopMobile" 					column="shop_mobile" />                                              
		<result property="shopAddress"	 				column="shop_address" />                                            
		<result property="deliveryAreaCode" 			column="delivery_area_code" />                                 
		<result property="deliveryStationCode" 			column="delivery_station_code" />                           
		<result property="shopLng" 						column="shop_lng" />                                                    
		<result property="shopLat" 						column="shop_lat" />                                                        
		<result property="receiveLng"	 				column="receive_lng" />                                                  
		<result property="receiveLat" 					column="receive_lat" />                                                  
		<result property="distance" 					column="distance" />                                                       
		<result property="orderSouce" 					column="order_source" />                                                 
		<result property="balanceMemberSatus" 			column="balance_member_status" />                      
		<result property="dmWorkNumber" 				column="dm_work_number" />                                                
		<result property="dmPhone" 						column="dm_phone" />                                              
		<result property="dmName" 						column="dm_name" />                                                
		<result property="controlledTime" 				column="controlled_time" />                                
		<result property="gettingTime" 					column="getting_time" />                                      
		<result property="shippingTime" 				column="shipping_time" />                                    
		<result property="arrivedTime" 					column="arrived_time" />                                      
		<result property="requirePickUpTime" 			column="require_pick_up_time" />                        
		<result property="requireArrivedTime" 			column="require_arrived_time" />                                                 
		<result property="companyKey" 					column="company_key" />                                                 
		<result property="carryOrder" 					column="carry_order" />                                                 
		<result property="dateVersion" 					column="data_version" />
		
		<result property="isDeleted" 					column="is_deleted" />                                                 

		<result property="createId" 					column="create_id" />                                                 
		<result property="createTime" 					column="create_time" />                                                 
		<result property="lastUpdateTime" 				column="last_update_time" />                                                 
		<result property="lastUpdateId" 				column="last_update_id" />        
		                                         
		<association property="member" column="dm_work_number" select="DistributionMember.findByWorkNubmer" />
	</resultMap>
	<resultMap type="com.zline.zlogistics.biz.dal.entity.LogisticsOrder" id="logisticsOrderTinyResult" >
		<id property="logisticsOrderId" column="logistics_order_id" />
		<result property="logisticsOrderCode" column="logistics_order_code" />
		<result property="logisticsOrderStatus" column="logistics_order_status" />
		<result property="shopName" column="shop_name" />
		<result property="dmName" column="dm_name" />
		<result property="shippingTime" column="shipping_time" />
		<result property="orderPrice" column="order_price" />
		<result property="isDeleted" column="is_deleted" />
	</resultMap>
	<resultMap type="com.zline.zlogistics.biz.dal.entity.LogisticsOrder" id="UnResolvedOrder" >
		<id property="logisticsOrderId" column="logistics_order_id" />
		<result property="shopName" column="shop_name" />
		<result property="oldOrderCode" 	column="old_order_code" />  
		<result property="requirePickUpTime" 	column="require_pick_up_time" />
		<result property="shopLat" 						column="shop_lat" />   
        <result property="shopLng" 						column="shop_lng" />  
        <result property="receiveLng"	 				column="receive_lng" />                                                  
        <result property="receiveLat" 					column="receive_lat" />  
		<association property="distributionStation" column="delivery_station_code" select="DistributionStation.findById" />
	</resultMap>
	<resultMap type="com.zline.zlogistics.biz.dal.entity.LogisticsOrder" id="logisticsOrderBalanceResult" >
	
		<id     property="logisticsOrderId"		column="logistics_order_id"/>
		<result property="logisticsOrderCode" 	column="logistics_order_code" />   
		<result property="needPay" 				column="need_pay" />  
		<result property="needPayReceive" 		column="need_pay_receive" />  
		<result property="payMethod" 			column="pay_method" />  
		<result property="inPrice" 				column="in_price" />
		<result property="orderPaymentMethod" 			column="order_payment_method" />   							
		<result property="orderPaymentMethodActual" 	column="order_payment_method_actual" />  	 
	
		<result property="balanceOrderCount" column="balanceOrderCount" />
		<result property="balanceDate" column="balanceDate" />
		<result property="dmWorkNumber" column="dmWorkNumber" />
		<result property="needPayTotal" column="needPayTotal" />
		<result property="needPayReceiveTotal" column="needPayReceiveTotal" />
		<result property="inPriceTotal" column="inPriceTotal" />
		<result property="waitPayTotal" column="waitPayTotal" />
		<association property="member" column="dm_work_number" select="DistributionMember.findByWorkNubmer" />
	</resultMap>
	<sql id="selectHeader">
	
		SELECT
		`logistics_order`.`logistics_order_id`,                            
		`logistics_order`.`logistics_order_code`,                          
		`logistics_order`.`old_order_code`,                                
		`logistics_order`.`send_status`,                                   
		`logistics_order`.`send_method`,                                   
		`logistics_order`.`logistics_order_status`,                        
		`logistics_order`.`need_pay`,                                      
		`logistics_order`.`need_pay_receive`,                              
		`logistics_order`.`order_estimated_picking_time`,                  
		`logistics_order`.`order_estimated_arrived_time`,                  
		`logistics_order`.`order_payment_method`,                          
		`logistics_order`.`order_payment_status`,                          
		`logistics_order`.`order_payment_method_actual`,                   
		`logistics_order`.`order_payment_status_actual`,                   
		`logistics_order`.`actual_pay`,                                    
		`logistics_order`.`order_price`,                                   
		`logistics_order`.`receiver_id`,                                   
		`logistics_order`.`receiver_city_code`,                            
		`logistics_order`.`logistics_info`,                                
		`logistics_order`.`in_price`,                                      
		`logistics_order`.`goods_count`,                                   
		`logistics_order`.`goods_weight`,                                  
		`logistics_order`.`receiver_province`,                             
		`logistics_order`.`receiver_city`,                                 
		`logistics_order`.`receiver_county`,                               
		`logistics_order`.`receiver_street`,                               
		`logistics_order`.`receiver_address`,                              
		`logistics_order`.`receiver_mobile`,                               
		`logistics_order`.`receiver_phone`,                                
		`logistics_order`.`goods_receiver`,                                
		`logistics_order`.`user_remark`,                                   
		`logistics_order`.`shop_id`,                                       
		`logistics_order`.`shop_name`,                                     
		`logistics_order`.`shop_mobile`,                                   
		`logistics_order`.`shop_address`,                                  
		`logistics_order`.`delivery_area_code`,                            
		`logistics_order`.`delivery_station_code`,                         
		`logistics_order`.`shop_lng`,                                      
		`logistics_order`.`shop_lat`,                                      
		`logistics_order`.`receive_lng`,                                   
		`logistics_order`.`receive_lat`,                                   
		`logistics_order`.`distance`,                                      
		`logistics_order`.`order_source`,                                  
		`logistics_order`.`balance_member_status`,                         
		`logistics_order`.`dm_work_number`,                                       
		`logistics_order`.`dm_phone`,                                      
		`logistics_order`.`dm_name`,                                  
		`logistics_order`.`controlled_time`,                               
		`logistics_order`.`getting_time`,                                  
		`logistics_order`.`shipping_time`,                                 
		`logistics_order`.`arrived_time`,                                  
		`logistics_order`.`require_pick_up_time`,                          
		`logistics_order`.`require_arrived_time`,                          
		`logistics_order`.`company_key`,                                   
		`logistics_order`.`carry_order`,                              
		`logistics_order`.`data_version`,                                  
		`logistics_order`.`is_deleted`, 
		
		`logistics_order`.`create_time`,                                   
		`logistics_order`.`create_id`,                                     
		`logistics_order`.`last_update_time`,                              
		`logistics_order`.`last_update_id`

		FROM `zlogistics`.`logistics_order`
	
	</sql>
	
	<select id="queryListLikeOrderCode" parameterType="com.zline.zlogistics.biz.dal.dto.LogisticsOrderDto" 
		resultMap="logisticsOrderTinyResult">
		SELECT 
			logistics_order_id,
			logistics_order_code,
			logistics_order_status,
			shop_name,
			dm_name,
			shipping_time,
			order_price,
			is_deleted
		FROM 
			`zlogistics`.`logistics_order`
		WHERE   is_deleted = 0 
		<if test="logisticsOrderId != null">
			AND logistics_order_id = #{logisticsOrderId}
		</if> 
		<if test="logisticsOrderCode != null and logisticsOrderCode !=''">
			AND logistics_order_code like concat('%',#{logisticsOrderCode},'%')
		</if>
		ORDER BY create_time desc
		<if test="firstRow != null">
			limit #{firstRow},#{pageRows}
		</if>
	</select>
	
	<select id="queryByKey" parameterType="java.lang.Long" resultMap="logisticsOrderFullResult">
		<include refid="selectHeader" />
		where
			is_deleted = 0
			AND logistics_order_id = #{id}
		limit 1
	</select>
	<select id="queryTotalInfo" parameterType="com.zline.zlogistics.biz.dal.dto.LogisticsOrderDto" 
										resultMap="logisticsOrderBalanceResult">
		SELECT 
			IF(count(1)=0,NULL,count(1)) as balanceOrderCount,
			date_format(arrived_time,'%Y-%m-%d') as balanceDate,
			dm_work_number,
			sum(need_pay) as needPayTotal,
			sum(need_pay_receive) as needPayReceiveTotal,
			sum(in_price) as inPriceTotal,
			(sum(need_pay)- sum(in_price)) as waitPayTotal
		FROM 
			`zlogistics`.`logistics_order`
		where 
			is_deleted = 0 
			AND  balance_member_status = 0
			AND  logistics_order_status =3
		<if test="keyword != null and keyword !=''">
			AND (dm_name  = #{keyword} or dm_work_number = #{keyword})
		</if>
		<if test="searchDate != null and searchDate !=''">
			<![CDATA[
				AND arrived_time > concat(#{searchDate},' 00:00:00') and arrived_time < concat(#{searchDate},' 23:59:59')
			]]>
		</if>
		<if test="dmWorkNumber != null">
			AND dm_work_number =#{dmWorkNumber} 
		</if>
		limit 1
	</select>
	
	<select id="queryBalanceList" parameterType="com.zline.zlogistics.biz.dal.dto.LogisticsOrderDto" 
										resultMap="logisticsOrderBalanceResult">
		<include refid="selectHeader" />
		WHERE 
			is_deleted = 0 
			AND  balance_member_status = 0
			AND  logistics_order_status =3
		<if test="searchDate != null and searchDate !=''">
			<![CDATA[
				AND arrived_time > concat(#{searchDate},' 00:00:00') and arrived_time < concat(#{searchDate},' 23:59:59')
			]]>
		</if>
		<if test="dmWorkNumber != null">
			AND dm_work_number =#{dmWorkNumber} 
		</if>
	</select>
	
	<select id="queryCount" parameterType="com.zline.zlogistics.biz.dal.dto.LogisticsOrderDto" 
		resultType="java.lang.Integer">
		SELECT 
			COUNT(1)
		FROM 
			`zlogistics`.`logistics_order`
		WHERE   is_deleted = 0 
		<if test="logisticsOrderId != null">
			AND logistics_order_id = #{logisticsOrderId}
		</if> 
		<if test="logisticsOrderCode != null and logisticsOrderCode !=''">
			AND logistics_order_code like concat('%',#{logisticsOrderCode},'%')
		</if>
	</select>
	
	
	<update id="balanceByDto" parameterType="com.zline.zlogistics.biz.dal.dto.LogisticsOrderDto" >
			UPDATE 	`zlogistics`.`logistics_order` 
				SET data_version =	data_version + 1
			<if test="balanceMemberStatus != null">
				,balance_member_status = #{balanceMemberStatus}
			</if>
			<if test="lastUpdateId !=null and lastUpdateId !=0">
					,last_update_id = #{lastUpdateId}			
			</if>
			WHERE logistics_order_id =#{logisticsOrderId}
	</update>
	
		<select id="getUnResolvedOrder"  parameterType="com.zline.zlogistics.biz.dal.dto.LogisticsOrderDto"  resultMap="UnResolvedOrder">
		<include refid="selectHeader" />
		where
			is_deleted = 0
			<if test="sendStatus!= null">
			AND send_status = #{sendStatus}
			</if>
			<if test="sendMethod!= null">
			AND send_method = #{sendMethod}
			</if>
			<if test="distributionStationIds !=null">
			AND delivery_station_code in
		   <foreach collection="distributionStationIds" separator="," open="(" close=")" item="item" index="index">
		      #{item}
           </foreach>
			</if>
	</select>
	
</mapper>