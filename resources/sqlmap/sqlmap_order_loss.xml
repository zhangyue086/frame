<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="orderLossMapper">
	<resultMap type="com.zline.zlogistics.biz.dal.entity.OrderLoss"
		id="orderLossResult">
		
		<id property="lossId" column="loss_id"/>
		<result property="orderId" column="order_id" />
		<result property="cityId" column="city_id" />
		<result property="stationId" column="station_id" />
		<result property="needPay" column="need_pay" />
		<result property="needPayReceive" column="need_pay_receive" />
		<result property="lossAccount" column="loss_account" />
		<result property="dmWorkNumber" column="dm_work_number" />
		<result property="dmName" column="dm_name" />
		<result property="lossDesc" column="loss_desc" />
		<result property="dataVersion" column="data_version" />
		<result property="isDeleted" column="is_deleted" />

		<result property="createId" column="create_id" />
		<result property="createTime" column="create_time" />
		<result property="lastUpdateTime" column="last_update_time" />
		<result property="lastUpdateId" column="last_update_id" />
		
		<association property="city" column="city_id" select="city.queryByKey"></association>
		<association property="station" column="station_id" select="DistributionStation.findById"></association>
		<association property="order" column="order_id" select="logisticsOrderMapper.queryByKey"></association>
	</resultMap>
	
	<sql id="selectHeader">
			SELECT
		`logistics_order_loss`.`loss_id`,                            
		`logistics_order_loss`.`order_id`,                          
		`logistics_order_loss`.`city_id`,                                
		`logistics_order_loss`.`station_id`,                                   
		`logistics_order_loss`.`need_pay`,                                   
		`logistics_order_loss`.`need_pay_receive`,                                   
		`logistics_order_loss`.`loss_account`,                                   
		`logistics_order_loss`.`dm_work_number`,                                   
		`logistics_order_loss`.`dm_name`,                        
		`logistics_order_loss`.`loss_desc`,                                      
		`logistics_order_loss`.`data_version`,                                  
		`logistics_order_loss`.`is_deleted`, 
		
		`logistics_order_loss`.`create_time`,                                   
		`logistics_order_loss`.`create_id`,                                     
		`logistics_order_loss`.`last_update_time`,                              
		`logistics_order_loss`.`last_update_id`

		FROM `zlogistics`.`logistics_order_loss`
	
	</sql>
	<update id="updateByKey" parameterType="com.zline.zlogistics.biz.dal.dto.OrderLossDto">
		UPDATE `zlogistics`.`logistics_order_loss`
			SET last_update_time=now(),data_version=data_version+1
			<if test="lossDesc != null">
				,loss_desc = #{lossDesc}
			</if>
			where loss_id =#{lossId} and is_deleted = 0
		
	</update>
	
	<select id="queryListByDto" parameterType="com.zline.zlogistics.biz.dal.dto.OrderLossDto" resultMap="orderLossResult">
		<include refid="selectHeader" />
		
		<where>
			is_deleted  = 0
			<if test="cityId != null">
				AND city_id = #{cityId}
			</if>
			<if test="orderId != null">
				AND order_id = #{orderId}
			</if>
			<if test="stationId != null">
				AND station_id = #{stationId}
			</if>
			<if test="dmWorkNumber != null">
				AND dm_work_number = #{dmWorkNumber}
			</if>
			<if test="dmName != null and dmName !=''">
				AND dm_name like concat('%',#{dmName},'%'}
			</if>
			<if test="startTime != null and startTime !=''">
				<![CDATA[
					AND create_time > #{startTime}
				]]>
			</if>
			<if test="endTime != null and endTime !=''">
				<![CDATA[
					AND create_time < #{endTime}
				]]>
			</if>
		</where>
		ORDER BY create_time desc
		<if test="firstRow != null">
			limit #{firstRow},#{pageRows}
		</if>
	</select>
	
	<select id="queryByKey" parameterType="java.lang.Long" resultMap="orderLossResult">
		<include refid="selectHeader" />
		where
			is_deleted  = 0
			AND loss_id = #{id}
		
	</select>
	<select id="queryCount" parameterType="com.zline.zlogistics.biz.dal.dto.OrderLossDto" resultType="java.lang.Integer">
		SELECT COUNT(1)		FROM `zlogistics`.`logistics_order_loss`
		<where>
			is_deleted  = 0
		<if test="cityId != null">
				AND city_id = #{cityId}
			</if>
			<if test="orderId != null">
				AND order_id = #{orderId}
			</if>
			<if test="stationId != null">
				AND station_id = #{stationId}
			</if>
			<if test="dmWorkNumber != null">
				AND dm_work_number = #{dmWorkNumber}
			</if>
			<if test="dmName != null and dmName !=''">
				AND dm_name like concat('%',#{dmName},'%'}
			</if>
			<if test="startTime != null and startTime !=''">
				<![CDATA[
					AND create_time > #{startTime}
				]]>
			</if>
			<if test="endTime != null and endTime !=''">
				<![CDATA[
					AND create_time < #{endTime}
				]]>
			</if>
		</where>
	</select>
	
	
</mapper>